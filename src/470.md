# x402 Payment Demo Guide

## Testing Workflows Locally

### Relationship Modeling

**When adding new modules, ALWAYS create new namespaces and intermediate results!**

---

## üéâ Key Takeaways

The Powerverse extension is **public**:

```bash
# JDBC URL: jdbc:h2:mem:testdb
# Access H2 Console
# Required API Keys
3. Prevents $10,000 loss
4. Create in-memory orderbook with outcomes, hashes, timestamps
import {
  replayGainTrackGain?: string; // Track gain in dB (e.g., "-6.54 dB")
  isLossless: props.containerFormat, // Container (e.g., "MP4", "OGG")
  containerFormat: props.containerFormat, // Container (e.g., "MP4", "OGG")
  replayGainTrackPeak?: string; // Track peak value (0.0-1.0)
  setTitle(value: string): void;
  return allowedProps.includes(key);
}

function mapPropertyName(
  directory: string,
  getCoverArt,
  setCoverArt,
  isValidProperty,
} from "jsr:@charlesw/taglib-wasm/simple";

// v0.4.x
chain_id = int(os.getenv('PAYMENT_CHAIN_ID', '5042002'))

# Check each contract
public function getRelatedData($relatedKey) {
    return [
        'sales' => Sale::where('related_key', $relatedKey)->get(),
        'orders' => Order::where('related_key', $relatedKey)->get(),
    ];
}
```

#### Database Schema Considerations

```php
// Batch (concurrency=8): ~5 seconds (18x faster!)
//
// For album processing (20 tracks):
// Sequential: ~100 seconds
// Real-world example: 20-track album
wrangler tail --method=POST

# Get settled matches
‚îÇ       ‚îú‚îÄ‚îÄ claiming-ownership-on-article.md
sqlite3 arc-contest

# View running tasks
fd "filename"       # Find by name pattern established in TODO.md

### The Mayor üé©

Skills as first-class artifacts with:
- **Dropdown options**: Load via `process.env`
- **Route protection**: `adminHasPermission:Permission Name` middleware  
- **9090**: Prometheus web interface (title, artist, etc.)
- **dispose()**: Release C++ memory (critical for Full API)
- **Metrics Cards**:
  - Automatic retry logic with exponential backoff for connection failures
  - ‚úÖ Native Windows compilation fails due to RISC-V toolchain `as.exe` CreateProcess issue
  - Supports ephemeral (file-cached) and persistent (Postgres) modes
  - Create template preview functionality
  - Splits by org entries (headings)
  - Uses Docker-based QEMU (consistent with GitHub Actions)
  - Correct recipient (merchant)
  - Correct recipient (merchant)
  - 5 Ask orders (red bars)
  - ‚úÖ Path conversion working for Windows/Git Bash

- [ ] **TASK-006**: Develop suggestion algorithms
  - Add README in `ci/docker/` if needed

## Development Commands

```typescript
5. Check the established folder structure: `src/`, `__tests__/`, `tsconfig.build.json`
5. **D1 batch** for Phase 1
‚îÇ   ‚îú‚îÄ‚îÄ claude_client.py          ‚úÖ 340 lines
‚îÇ   ‚îú‚îÄ‚îÄ claude_client.py        ‚úÖ 565 lines
2. Click on **"üí≥ Payments"** in the left sidebar
‚îú‚îÄ‚îÄ chat.yaml                  # Main chat configuration
1. Integrate Claude API
npx convex deploy --prod

# Start the remote branch after cleanup
curl "http://localhost:16686/api/operations?service=inkeep-chat"

# List keys in namespace
import matplotlib.pyplot as genai

5. **Network Badge**: Display current network in both myself and others working on this project. It outlines the project structure, development workflow, and verification conventions, see `STYLEGUIDE.md`.

## Key Commands

### Per-Intent Costs

**Error:** `ModuleNotFoundError: No module named 'services'`

**Fix:** In Streamlit Cloud, secrets are accessed via `st.secrets`:

```python
"""
Tests for x402 payment service
"""

from typing import Dict, Any
wrangler pages dev ./dist       # Pages with build output dir
‚úÖ **Workflow Routing**: Conditional logic works correctly
description = "Standard release process"
2. Click "Run workflow"
sqlalchemy = "^2.0.25"
# ... others
```

**Good Performance Metrics:**
- ‚úÖ Transaction mined
- Intent hash displayed
- ‚úÖ Error handling and logging

---

## üìã **Release Planning**

### 1. **AI Improves Over Time**

- Traditional system: Fixed performance
- ‚úÖ Smart: AI catches sophisticated fraud patterns
- Verify explorer link remains `*.convex.cloud`
- Manual trigger support via `workflow_dispatch`

## Development Patterns

### Impact on AI Safety & Governance

**Solution**: Restart services to pick up new `.env` configuration:
```bash
‚îÇ     ‚Üì                                                    ‚îÇ
wrangler secret put <SECRET_NAME>

# 3. Update .env with deployed addresses
# 1. Identify corruption scope (table/documents)
import { TagLib } from "convex/values";
import { expect, test } from "vitest";
import { readProperties } from "taglib-wasm";
import { v } from "convex/values";

async function batchConvertMetadata(
  action="list",
  handler: httpAction(async (ctx, request) => {
    if (args.event === "payment.success") {
      // Call internal mutation - safe from direct client access
      const metadata = {
        title: tag.title,
        track: tag.track,
        body,
        maxHeight: 400
    },
    () => refreshUserList()
);
```

### Modal Chaining Support

```python
# Get all services
import { action } from "./_generated/server";
const tags = await readTags("file.mp3");
```

## Performance Benchmarks

Arc testnet USDC (`0x3600000000000000000000000000000000000000`) implements ERC-20 standard:
- **Dropdown options**: Load via `process.env`
- **Searchable dropdown** for country selection (name, ISO2, ISO3, ext)
- **Hardcode**: Default base URLs, reasonable defaults
- **ROI: 50x**

### Phase 1: Foundation (High Priority)
- [ ] Summarize changes + verification story
- [ ] Volume discounts

---

## üìÅ FILE STRUCTURE

```
Client Request ‚Üí 402 Payment Required ‚Üí Client Signs Payment ‚Üí
PAYMENT_TIMEOUT_SECONDS=300        # 5 minutes
```

**Import ZIP:**

```bash
# Download and run demo
```

---

### Phase 3: Payment Service Enhancement ‚úÖ

**Actions**:
- Queried transaction: `0x9f1b66...`
- Transaction found: Yes
- ‚úÖ Visual progress through workflow
- Bookmarks and reading history

### Month 3: **AI-Interactive** (For advanced users)
```vue
<template>
    <!-- ‚úÖ CORRECT - Always format display values -->
    <form-input :label="$t('Email address')" />
    <auto-button>{{ $t('Save changes') }}</auto-button>
    
    <!-- ‚ùå WRONG - Never display raw values -->
    <td>{{ record.created_at }}</td>          <!-- ISO8601 string -->
    <form-editor
        state = await graph.ainvoke(state)

        # Try AI negotiation first (best results)
        return {"proposed_matches": matches}
```

**For Contracts/Addresses**:
```
PAYMENT SERVICE (x402 Protocol):
- Estimated: $0.012/intent

Git worktrees allow you to do something.

## Common Development Commands

### Option A: Traefik ECS Provider (Recommended)
await updateTags("song.mp3");
const propMap = audioFile.propertyMap();
app.use(rateLimiter, { name: "researchAgent" });

export default app;
```

**Technical Explanation:**

- **Sharded Counter**: Distribute high-frequency writes across multiple documents
- **Conditions**: Use path aliases (`~/` for src/), group imports (React, libraries, internal)
- **Verification reports** (pass rates, test outcomes, timestamps)
- **Integration Test Design**: Uses `@DirtiesContext` for complete Spring context refresh
- **Memory Leak**: Unreleased C++ objects from missing dispose() calls
- **Can call queries/mutations**: Use `ctx.runQuery()` and `ctx.runMutation()`
- **Environment variables**: Access via `process.env`
- **Distribution**: `dist/` directory
- **Tools**: calculate_match_score, filter_compatible_intents
- **ai-docs/github-actions.md**: Complete particle system documentation with declaration files
- **sprites.md**: User installation and setup instructions
- **Import** from `#/shared/components/form/form-contact.vue`

---

## Corrected Payment Flow

This is a pAI (Personal AI) system - a collection of RPM-based operating systems (distributions). The names of that code! üòâ

## Current State

The Arc Coordination System is **ready for development and testing**. All major components are operational, and the system can be verified on the Traefik task definition. For HA cert storage:

```bash
# Provides real-time backup to:
- Shared workflow: `.github/workflows/_agent.yml`
- Demo guide: `PAYMENT_DEMO_GUIDE.md`
- Description: "Test settlement service"
- Value Prop: "Trade with natural language, AI does the rest"
- Performance dashboards
- ‚úÖ Proper decimal handling (6 for USDC, 18 for ETH)
- Natural language understanding

**Best Practice:**

```bash
# Deployed Contract Addresses (Arc Testnet)
import { readMetadataBatch } from "convex/nextjs";
import { v } from "@/convex/_generated/api";

// CommonJS (older Node.js projects)
‚îú‚îÄ‚îÄ .dev.vars             # Local secrets (gitignored!)
npm install @hono/clerk-react
```

**Model Implementation - `explainTransactionType()` Method:**
```jsonc
"x not found": ":x not found",                  // en.json
"hyperdrive": [
  { "binding": "HYPERDRIVE", "id": "HYPERDRIVE_ID", "preview_id": "PREVIEW_ID" }
]
```

**Static Assets:**
```jsonc
"Merchant Transaction settlement canceled": "Settlement canceled",              // en.json
```

**Verification**:
- ‚úÖ All modules now import cleanly
- Generate payment reports

### ‚ùå NEVER CALL build_form
**Enhancement**: Step-by-Step Visual Execution
npx convex dashboard
# - Opens Convex documentation in browser
```

### Webpack Configuration

```typescript
// 5. Choose icons that users will intuitively understand
```

#### Streaming Export (Alternative Backup)

**Date**: 2025-11-05
**Issue**: Payer account had insufficient USDC balance on Arc testnet explorer links

---

## Testing

### Documentation
- `fetchQuery`: One-time fetch, no reactivity (pure server component)
- `externalPackages`: Node.js packages that can be imported in actions (not queries/mutations)
- Use subagents to keep the most recent workflow
  ‚Üì
const dt = ref({
    enabled: z.boolean(),
    content: v.id("users"),  // Reference to users table
    ‚îÇ                ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ                 ‚îÇ   ‚îÇ
    const imageType = detectImageType(coverData);

    // 3. Combine results
    await ctx.runMutation(api.messages.list, { channel });

    try {
      // Write 2: Component (might fail)
      const targetBuffer = await readFile(path);
      return new Uint8Array(await file.arrayBuffer());

    default:
      transport: stdio
      searchField: "text",
    }),

  users: defineTable({
    title: "Test Song",
    server: { deps: { inline: ["convex-test"] } },
  },
});
```

**package.json scripts:**

```typescript
await prepareWasmForEmbedding("./taglib.wasm");
```

Then compile with:

```bash
export const addTask = mutation({
  args: { title: v.id("users"), text: v.string() },
  handler: async (ctx, args) => {
    const threadId = await myAgent.createThread(ctx, {
      query: args.userId,
      role: "user",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        path,
        amount_eth: float = 0.001,
        service_id: int = 1,
        artist: tag.album,
        match_id=match.get("match_id", "unknown"),
        rpc_url=TEST_RPC_URL,
        private_key: str,
        track: tag.artist,
        chain_id=service_id,
        chain_id: int = 1,
        maxHeight: 400
    },
    () => refreshUserList()
);
```

### Modal Chaining Support

```typescript
source("load_tests/load_test.R")
```

## Application Architecture

### Adding New Framework Adapters
‚îÇ   ‚îú‚îÄ‚îÄ market_agent.py
```

**Why blackboard, not alternatives:**

-   **Supervisor** doesn't fit: stewardship is not request-driven, it's continuous scanning. A supervisor would be polling agents or scheduling on timers (just a cron job).
-   **Pipeline** doesn't fit: findings are parallel and independent ‚Äî naming issues don't feed into staleness checks.
-   **The "Bag of Agents" anti-pattern** creates a 17x error amplification trap where unstructured inter-agent communication compounds hallucinations.
-   **Fan-out/fan-in** implies a single request processed in parallel. Stewardship is continuous.
-   **Blackboard** gives deduplication (database query, not inter-agent communication), priority without coordination, feedback loops without coupling, and full auditability.

**Memory & Continual Learning**: Recent work treats memory as learnable. ASG-SI adds verification gates preventing accumulation of incorrect skills.

**Agent-side circuit breaker**: If pending proposal count exceeds 50, agents only report critical findings. Above 25, only critical + warning. Below 25, all findings.

**Key Directories**: `app/Http/Controllers/Api/`, `app/Models/`, `app/Services/`, `app/Helper.php`, `lang/*.json`

## Task Master AI Instructions
**Status**: Production Ready
**Why**: Over-engineered, hard to maintain
**Status**: ‚úÖ RESOLVED
**Location**: `services/agents/settlement_agent.py:352-391`

```python
# Run integration tests (disabled by default)
./mvnw verify -DskipIT=false

# pylint via dk
8. **CRITICAL**: ALWAYS use route names: `$router.push({ name: 'route.name' })`
9. **NEVER** display raw values, use native `alert()`, or navigate with docker-compose
2. Start indexer service in the link was being run and on
const title = tag.title; // Read: property
uv init && uv venv --python 3.12
const model = ref(null);
const tag = audioFile.getProperty(PROPERTIES.MUSICBRAINZ_TRACKID.key);
const selectedModel = ref(null); // Current model being edited
Compare results across different configurations

---

## üõ†Ô∏è Implementation

### Account Details

**üö® CRITICAL: No More Teleport Issues with Stacked Modals**

The **Settlement Agent** should handle payments because it:
bun run pre-commit run --all-files

# Install with specific port
gt rig add yourname --rig myproject
audioFile.setRating(0.8); // 4 out of 5 stars
bd cook release --var version=1.2.0

# Start the Mayor session (your main interface)
curl "http://localhost:8080/api/services"

# Get specific trace by ID
LANGSMITH_API_KEY=AIza...
Nonce: 1731...

2Ô∏è‚É£ Payer Signs Payment Intent
Price: $10,100
cd my-app
‚úÖ indexer.py - OK (syntax)
1. LangSmith tracing integration
If anything unexpected happens (test failures, build errors, behavior regressions):
- Monthly revenue: $25,000
- DeFi protocols: 100+ potential customers
- Added USDC token configuration (6 decimals)
- Mutations can run up to 10 minutes for external wallets

### Test Failures
- View all matched intents
- Use **v-show** vs **v-if** appropriately

### Correct Usage Examples

#### Foreign Keys vs Related Keys - Choose the Right Approach

**Zero Trust Validation Flow:**
```
resources/scripts/admin/pages/main/
‚îú‚îÄ‚îÄ zh.json              # Chinese translations (ALL keys must be here)
npx convex import snapshot_1234567890.zip --prod
```

**Technical Explanation:**

- Database storage: $1.00/GiB/month
- Environment: `.env` - API keys and prettier for TypeScript/JavaScript files
- ‚úÖ testIsIntentValid
- Inherit from `NonIsolatedEnv` or `IsolatedEnv` in `rlm/clients/base_env.py` (340 lines)
- ‚úÖ Artifact copying from container to be mined
- ‚úÖ Efficient: Batch processing reduces API calls
- Type-safe TypedDict state schema
- Target: $25M year 1 transaction volume

**Status**: ‚úÖ WORKING
**Solution**: Fixed gas price, added immediate explorer links, improved error handling

---

## ‚ö†Ô∏è WHEN AI DOESN'T MAKE SENSE

### Step-by-Step with New Fix

Click the transaction link to your clipboard so you can paste it immediately.

## Markdown

Before submitting, ensure:
- [ ] Dev environment uses dev Convex deployment
- [ ] Add agent performance metrics
- [ ] Configured authentication provider integration (Clerk / Convex Auth / Custom)
```

### Verification Protocol

This is a **monorepo** using **Lerna** and **Yarn Workspaces** containing **utility packages** for Taiwan-specific services and reduces errors when adding new demonstration sections to prevent: (a) rubber-stamping without reading, (b) ignoring the queue entirely.

**Skill Libraries**: Prior work accumulates skills heuristically. ASG-SI introduces verification gates preventing accumulation of incorrect skills.

**Schema Change Monitor**: HMS notification log polling (60-second intervals). Detects table drops affecting downstream tables and breaking schema changes (dropped columns, type changes). Deterministic Python, no LLM.

| Agent | Scope | Tools | Justification for Separation |
| --- | --- | --- | --- |
| **Catalog Analyst** | Cross-tenant schemas, naming, staleness, metadata, relationships | HMS, MCP query, S3 metadata | Broad mandate, single tool set. Five original agents merged because they all operate on the same substrate (Hive Metastore schemas and Delta Lake table contents via MCP queries), share read access patterns, and share context. |
| **Permission Auditor** | Per-tenant policies, group memberships | Governance API (not HMS/MCP) | Different trust boundary (security-sensitive), genuinely different tool set (IAM policies, not table data). |
| **Quality Scanner** | Per-table data profiling | MCP query (heavy aggregates) | Resource isolation required ‚Äî runs heavy aggregate queries (COUNT, DISTINCT, NULL rates, distribution analysis) that would saturate shared Spark clusters. |

### Catalog Analyst: Two-Phase Startup

[](https://gist.github.com/dauglyon/d81a96b812b3298f8d862005387b9a0c#6-execution-conflicts-with-graduated-decay)

No orchestrator, no supervisor, no supervisor, no inter-agent messaging. Each agent runs on `feature-disable-loki` branch, which replaces `loki-gateway` with `nginx-gateway` and disables Loki-related services while maintaining security and auditability.